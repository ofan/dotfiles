#!/bin/bash

if [ "$1" = "-h" ];then
    echo "$0 [timeout] [code]"
    exit
fi

#default handler
_timeout() { return 0; }

#default code needs to be executed
_main() { echo "No _main found"; }

TIMEOUT=$1
if [ -z "$TIMEOUT" ]; then
    #default timeout
    TIMEOUT=3
elif [ $TIMEOUT -eq 0 ]; then
    TIMEOUT=3
fi

#read code from stdin if no code is given in arguments
# NOTICE: DO NOT EVER put backquotes in comments in $CODE, they will be evaluated too!!
CODE="$2"
if [ -z "$CODE" ];then
    CODE=`cat`
fi

# Load code, but don't run it.
# NOTICE: Global code(not in any functions) in $CODE will be executed
eval "$CODE"

# Setup up signal handler
trap _timeout USR1

# Spawn a timer process, sends back a signal when it exits
(sleep $TIMEOUT; kill -USR1 $$ &> /dev/null) &

# Enter the main function in $CODE
_main
